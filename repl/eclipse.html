<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Python 編輯器 + Terminal (Pyodide)</title>

<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/eclipse.min.css">

<style>
body { margin:0; font-family: monospace; font-size:24px; height:100vh; display:flex; background:#1e1e1e; color:#fff; }
#container { display:flex; width:100%; height:100%; visibility:hidden; }
#editor-container, #terminal-container { width:50%; height:100%; display:flex; flex-direction:column; min-width:0; }
#editor-container { border-right:2px solid #444; }
.CodeMirror { flex:1; height:100%; font-size:24px; }
#output { flex:1; background:#1e1e1e; padding:10px; overflow-y:auto; white-space:pre-wrap; border-bottom:2px solid #444; font-size:24px; }
.error { color:#fbcfd0; }
#input { height:100px; background:#2e2e2e; color:#0f0; padding:10px; border:none; resize:none; font-family:monospace; font-size:24px; }
#run-btn { width:100%; padding:10px; font-size:24px; background:#333; color:#fff; border:none; cursor:pointer; }
#run-btn:hover { background:#555; }

/* Loading 樣式 */
#loading {
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:#1e1e1e;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index:1000;
    font-size:24px;
    color:#0f0;
}
.loader {
    border: 6px solid #333;
    border-top: 6px solid #0f0;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin-bottom:20px;
}
@keyframes spin {
    0% { transform:rotate(0deg);}
    100% { transform:rotate(360deg);}
}
</style>
</head>
<body>

<div id="loading">
    <div class="loader"></div>
    <div>Python 環境載入中...</div>
</div>

<div id="container">
    <div id="editor-container">
        <textarea id="editor"># 範例: 多行 input + 正確 print
name = input()
age = int(input())
print(f"{name} {age}")
print("Hello", name, "you are", age, "years old")</textarea>
    </div>
    <div id="terminal-container">
        <div id="output"></div>
        <textarea id="input" placeholder="輸入多行，每行對應一個 input()" spellcheck="false"></textarea>
        <button id="run-btn" disabled>執行程式</button>
    </div>
</div>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/keymap/sublime.min.js"></script>

<script>
let pyodide = null;

// 初始化 CodeMirror
let editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
    lineNumbers:true,
    mode:"python",
    theme:"eclipse",
    indentUnit:4,
    tabSize:4,
    matchBrackets:true,
    autoCloseBrackets:true,
    keyMap:"sublime",
    extraKeys:{
        Tab: cm => { if(cm.somethingSelected()) cm.indentSelection("add"); else cm.replaceSelection("    ","end"); },
        "Shift-Tab": cm => cm.indentSelection("subtract")
    }
});
editor.setSize("100%","100%");

const outputArea = document.getElementById("output");
const inputArea = document.getElementById("input");
const runBtn = document.getElementById("run-btn");

// 載入 Pyodide
async function initPyodide() {
    pyodide = await loadPyodide();
    document.getElementById("loading").style.display = "none";
    document.getElementById("container").style.visibility = "visible";
    runBtn.disabled = false;
}
initPyodide();

// 執行程式
runBtn.addEventListener("click", async ()=>{
    outputArea.innerHTML = "";
    let code = editor.getValue();

    // 將多行輸入拆成陣列，每次 input() 取一行
    let inputLines = inputArea.value.replace(/\r\n/g,"\n").split("\n");
    let inputIndex = 0;

    // 攔截 print() 與 input()
    pyodide.globals.set("print", (...args)=>{
        let text = args.map(a => String(a)).join(" ");
        outputArea.innerHTML += text + "<br>";
    });
    pyodide.globals.set("input", ()=>{
        if(inputIndex < inputLines.length){
            let line = inputLines[inputIndex];
            inputIndex++;
            return line;
        } else {
            return "";
        }
    });

    try {
        await pyodide.runPythonAsync(code);
    } catch(err) {
        // 只顯示行數 + 類型 + 訊息
        let lineNumber = "未知行";
        if(err.stack){
            let match = err.stack.match(/<exec>.*line (\d+)/);
            if(match) lineNumber = match[1];
        }
        let errStr = err.toString();
        outputArea.innerHTML += `<span class="error">Line ${lineNumber}: ${errStr}</span><br>`;
    }
});
</script>

</body>
</html>
